<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BreraBot ‚Äî Accesso Riservato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        // GUARD: Se gi√† loggato (client-side), vai alla dashboard
        if (localStorage.getItem("auth")) window.location.href = "/";
    </script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center overflow-hidden relative">

    <!-- Background Glow -->
    <div class="absolute top-1/4 left-1/3 w-80 h-80 bg-purple-600/15 rounded-full blur-3xl"></div>
    <div class="absolute bottom-1/4 right-1/3 w-80 h-80 bg-blue-600/10 rounded-full blur-3xl"></div>

    <!-- Login Card -->
    <div class="relative z-10 w-full max-w-sm mx-4">
        <div class="bg-slate-800/80 backdrop-blur-xl border border-slate-700/50 rounded-2xl shadow-2xl p-8 space-y-6">

            <!-- Logo -->
            <div class="flex justify-center">
                <img src="/static/logo.png" alt="BreraBot" class="h-16 w-auto drop-shadow-lg">
            </div>

            <!-- Title -->
            <div class="text-center space-y-1">
                <h1
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-blue-400">
                    Accesso Riservato
                </h1>
                <p class="text-sm text-slate-400">Inserisci il tuo PIN per continuare</p>
            </div>

            <!-- Form -->
            <form onsubmit="doLogin(event)" class="space-y-4">
                <div>
                    <input type="password" name="pin" placeholder="‚óè ‚óè ‚óè ‚óè" maxlength="8" required autofocus
                        inputmode="numeric" class="w-full bg-slate-900/60 border border-slate-600/50 text-white text-center text-2xl tracking-[0.5em]
                               rounded-xl px-4 py-4 placeholder-slate-500
                               focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500
                               transition-all duration-200">
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-purple-700
                           hover:from-purple-500 hover:to-purple-600
                           text-white font-semibold py-3 rounded-xl
                           transition-all duration-200 transform hover:scale-[1.02]
                           shadow-lg shadow-purple-900/30">
                    <span class="flex items-center justify-center gap-2">
                        üîê Accedi
                    </span>
                </button>
            </form>

            <!-- Error Message (JS Toggle) -->
            <div id="js-error" class="hidden bg-red-500/10 border border-red-500/30 rounded-lg px-4 py-3 text-center">
                <p class="text-red-400 text-sm font-medium">Errore sconosciuto</p>
                <div class="text-red-300 text-xs mt-2 font-mono text-left bg-black/20 p-2 rounded overflow-x-auto"
                    id="js-error-detail"></div>
            </div>

            <!-- Footer -->
            <p class="text-center text-xs text-slate-500 pt-2">
                Value Investing √ó Metodo Brera
            </p>
        </div>
    </div>

    <script>
        async function doLogin(event) {
            event.preventDefault();
            const form = event.target;
            const pin = form.pin.value;
            const btn = form.querySelector('button');
            const errBox = document.getElementById('js-error');
            const errDetail = document.getElementById('js-error-detail');

            // Reset UI
            errBox.classList.add('hidden');
            errDetail.innerHTML = "";
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Verifica...';

            try {
                const r = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ pin })
                });

                // Leggi testo UNA volta sola
                const rawText = await r.text();

                if (!r.ok && r.status !== 401) {
                    throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                }

                let d;
                try {
                    d = JSON.parse(rawText);
                } catch (e) {
                    // Safe Encode HTML for display
                    const snippet = rawText.substring(0, 300)
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");

                    console.error("Non-JSON:", rawText);
                    throw new Error(`Ricevuto HTML invece di JSON:<br><br>${snippet}...`);
                }

                if (d.success) {
                    localStorage.setItem("auth", "1");
                    window.location.href = "/";
                } else {
                    errBox.classList.remove('hidden');
                    errBox.querySelector('p').innerText = "‚ö† " + (d.error || "Pin Errato.");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (e) {
                console.error(e);
                errBox.classList.remove('hidden');
                errBox.querySelector('p').innerText = "‚ö† Errore:";
                errDetail.innerHTML = e.message;
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>

</html>
